this.Newired=this.Newired||{},this.Newired.Storage=function(e){"use strict";const t="newired-cross-domain-storage-iframe",s="newired-iframe",o="newired-portal",i=function(e){try{return e.name===t||e.name===s||e.name===o}catch(e){return!0}}(window)?window:function(){const e=s;let t=document.getElementById(e);if(t||(t=document.createElement("iframe"),t.setAttribute("id",e),t.style.display="none",t.style.visibility="hidden",document.body.appendChild(t)),!t.contentWindow)throw new Error(`Browsing context of "${e}" window is discarded.`);return t.contentWindow}();function a(e){if(e&&"object"==typeof e){e.toJSON&&(e.toJSON=function(){return e});for(const t in e)e[t]=a(e[t])}return e}Function.prototype.safeBind=i.Function.prototype.bind,Function.prototype.safeApply=i.Function.prototype.apply,String.prototype.safeTrim=i.String.prototype.trim;var r,n={Set:i.Set.bind(window),setTimeout:i.setTimeout.bind(window),setInterval:i.setInterval.bind(window),clearTimeout:i.clearTimeout.bind(window),clearInterval:i.clearInterval.bind(window),scrollTo:(e,t,s)=>i.scrollTo.call(e,t,s),JSON:{stringify:function(e,t,s){return i.Prototype&&(e=a(e)),JSON.stringify(e,t,s)},stringifyPretty:function(e){return i.Prototype&&(e=a(e)),JSON.stringify(e,null,"  ")}},array:{push:function(e,t){i.Array.prototype.push.call(e,t)},pushApply:function(e,t){i.Array.prototype.push.apply(e,t)},unique:function(e){return i.Array.from(new Set(e))}}};!function(e){e.Never="Never",e.Year="Year",e.Day="Day"}(r||(r={}));const l="NW_",u="NW_global_";class c{static createCookie(e,t,s){const o=this.createCookieExpirationEntry(s);document.cookie=`${encodeURIComponent(e)}=${encodeURIComponent(t)}${o}; path=/`}static createCookieExpirationEntry(e){const t=this.calculateExpirationDate(e);return t?`; expires=${t.toUTCString()}`:""}static calculateExpirationDate(e){const t=new Date;if(!e)return t.setMinutes(t.getMinutes()+20),t;switch(e){case r.Never:t.setFullYear(t.getFullYear()+10);break;case r.Year:t.setFullYear(t.getFullYear()+1);break;case r.Day:t.setDate(t.getDate()+1);break;default:t.setTime(t.getTime()+e)}return t}static readStorageItem(e){const t=localStorage.getItem(e);if(!t)return null;const s=JSON.parse(t);return Date.now()>s.expiration?(localStorage.removeItem(e),null):decodeURIComponent(s.value)}static readCookie(e){try{const t=encodeURIComponent(e)+"=",s=document.cookie.split(";");for(let e=0;e<s.length;e++){let o=s[e];for(;" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(t))return decodeURIComponent(o.substring(t.length,o.length))}return null}catch(e){return null}}static eraseCookie(e){try{document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/"}catch(e){}}static existsKey(e){return null!=this.getValue(e)}static createStorageItem(e,t,s){const o={value:encodeURIComponent(t),expiration:this.calculateExpirationDate(s).getTime()};localStorage.setItem(e,JSON.stringify(o))}static storeValue(e,t,s){this.useHtml5Storage()?this.createStorageItem(l+e,t,s):this.createCookie(l+e,t,s)}static getValue(e){return this.useHtml5Storage()?this.readStorageItem(l+e):this.readCookie(l+e)}static getValues(e){const t={};return e.forEach((e=>{t[e]=this.getValue(e)})),t}static removeValue(e){this.useHtml5Storage()?localStorage.removeItem(l+e):this.eraseCookie(l+e)}static removeValues(e){e.forEach((e=>{this.removeValue(e)}))}static storeGlobalValue(e,t,s,o){this.useHtml5Storage(o)?this.createStorageItem(u+e,t,s):this.createCookie(u+e,t,s)}static getGlobalValue(e,t){return this.useHtml5Storage(t)?this.readStorageItem(u+e):this.readCookie(u+e)}static getGlobalValues(e,t){const s={};return e.forEach((e=>{s[e]=this.getGlobalValue(e,t)})),s}static removeGlobalValue(e,t){this.useHtml5Storage(t)?localStorage.removeItem(u+e):this.eraseCookie(u+e)}static removeGlobalValues(e,t){e.forEach((e=>{this.removeGlobalValue(e,t)}))}static clean(){this.getStoredKeys().forEach((e=>{localStorage.removeItem(e)}))}static getStoredKeys(){let e=0,t=null;const s=[];for(;t=localStorage.key(e++);)t.startsWith(l)&&n.array.push(s,t);return s}}c.useHtml5Storage=function(e){return"Cookies"!==e};const g=t;class d{constructor(e){this.globalStorageUrl=e,this.logContext="[GlobalStorage]["+location.host+"] ",this.storageReadyWarningTimeout=2e3,this.storageReadyErrorTimeout=3e3,this.requestTimeout=2e3,this.requestId=0,this.iframe=null,this.iframeReady=!1,this.queue=[],this.requests={},this.disabled=!1,this.timestampsWatcher=null,this.isDisabled=()=>this.disabled}init(){if(this.onGlobalStorageOrigin())console.debug(`${this.logContext}Runs on cross-domain storage URL. IFrame initialization skipped.`);else if(m(window))console.debug(`${this.logContext}Runs inside storage IFrame. IFrame initialization skipped.`);else if(null!==this.globalStorageUrl){console.debug(`${this.logContext}Initialized cross-domain storage IFrame with URL: ${this.globalStorageUrl}`);try{if(!this.iframe){if(!window.localStorage)return void console.error(`${this.logContext} Unsupported browser. Can not setup cross-domain storage.`);this.iframe=document.createElement("iframe"),this.iframe.id=g,this.iframe.name=g,this.iframe.style.cssText="position:absolute;width:1px;height:1px;left:-9999px;",document.body.appendChild(this.iframe),window.addEventListener("message",(e=>{this.handleMessage(e)}),!1)}this.iframe.src=this.globalStorageUrl}catch(e){console.debug("Creation cross-domain storage iframe failed.",e)}this.setTimestampWatcher(),n.setTimeout((()=>{this.iframeReady||console.warn(`${this.logContext}Newired global storage on "${this.globalStorageUrl}" still not ready.`)}),this.storageReadyWarningTimeout),n.setTimeout((()=>{this.iframeReady||(console.error(`${this.logContext}Newired global storage on "${this.globalStorageUrl}" still not ready. Cross-domain journeys will not work.`),this.dispose())}),this.storageReadyErrorTimeout)}else console.debug(`${this.logContext}No cross-domain storage URL. IFrame initialization skipped.`)}dispose(){this.shutdownQueue(),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null)}requestValue(e,t,s){if(null===this.globalStorageUrl||this.isDisabled())t&&t("Can not requestValue on disabled storage",e,null);else if(this.onGlobalStorageOrigin())t(null,e,c.getGlobalValue(e,s));else{const o={request:{operation:"get-value",key:e,storageType:s,id:this.nextRequestId()},callback:t,timestamp:(new Date).getTime()};this.enqueueRequest(o)}}requestValues(e,t,s){if(null===this.globalStorageUrl)t&&t("Can not requestValue on disabled storage",e);else if(this.onGlobalStorageOrigin())t(null,e,c.getGlobalValues(e));else{const o={request:{operation:"get-values",keys:e,storageType:s,id:this.nextRequestId()},callback:t,timestamp:(new Date).getTime()};this.enqueueRequest(o)}}storeValue(e,t,s,o){if(null!==this.globalStorageUrl)if(this.onGlobalStorageOrigin())c.storeGlobalValue(e,t,s,o);else{const i={request:{operation:"store-value",key:e,value:t,id:this.nextRequestId(),expiration:s,storageType:o}};this.enqueueRequest(i)}}removeValues(e,t){if(null!==this.globalStorageUrl)if(this.onGlobalStorageOrigin())c.removeGlobalValues(e,t);else{const s={request:{operation:"remove-values",keys:e,storageType:t,id:this.nextRequestId()}};this.enqueueRequest(s)}}clean(){if(null!==this.globalStorageUrl)if(this.onGlobalStorageOrigin())c.clean();else{const e={request:{operation:"clean-storage",id:this.nextRequestId()}};this.enqueueRequest(e)}}enqueueRequest(e){this.isDisabled()||(this.iframeReady?this.sendRequest(e):n.array.push(this.queue,e),this.iframe||this.init())}sendRequest(e){e.callback&&(this.requests[e.request.id]=e),null!==this.iframe&&null!==this.iframe.contentWindow?this.iframe.contentWindow.postMessage(n.JSON.stringify(e.request),this.globalStorageUrl):console.debug(`${this.logContext}Global storage iframe unloaded. Request ignored.`)}iframeLoaded(){for(this.iframeReady=!0;this.queue.length>0;){const e=this.queue.shift();this.sendRequest(e)}}shutdownQueue(){this.disabled=!0;if(this.queue.length>0)for(let t=0,s=this.queue.length;t<s;t++){const s=this.queue[t];(e=s).hasOwnProperty("callback")&&e.callback&&e.callback("Global storage disabled.")}var e;this.queue=[],this.requests={},this.disposeTimestampWatcher()}nextRequestId(){return this.requestId===Number.MAX_VALUE&&(this.requestId=0),this.requestId++}disposeTimestampWatcher(){this.timestampsWatcher&&clearInterval(this.timestampsWatcher)}setTimestampWatcher(){const e=(e,t)=>void 0!==e&&e.timestamp&&t-e.timestamp>this.requestTimeout,t=e=>{e.callback&&e.callback(`Request timed out (${this.requestTimeout} ms), Global storage page: ${this.globalStorageUrl}`)},s=()=>{const s=(new Date).getTime();for(const o in this.requests)if(this.requests.hasOwnProperty(o)){const i=this.requests[o];e(i,s)&&(delete this.requests[o],t(i))}},o=()=>{const s=(new Date).getTime(),o=[];for(;this.queue.length>0;){const i=this.queue.shift();e(i,s)?t(i):n.array.push(o,i)}this.queue=o};this.timestampsWatcher=window.setInterval((()=>{s(),o()}),1e3)}onGlobalStorageOrigin(){const e=document.createElement("a");return e.href=this.globalStorageUrl,e.origin===window.origin}handleMessage(e){if(h(e.origin)===h(this.globalStorageUrl))try{const t=JSON.parse(e.data),s=this.requests[t.id];delete this.requests[t.id],"response-get-value"===t.operation?s&&s.callback&&s.callback(null,t.key,t.value):"response-get-values"===t.operation?s&&s.callback&&s.callback(null,t.keys,t.values):"storage-ready"===t.operation&&(console.debug(`${this.logContext}Global storage ready (requests in queue: ${this.queue.length})`),this.iframeLoaded())}catch(e){}}}function h(e){const t=document.createElement("a");return t.href=e,t.hostname}function m(e){try{return e.self!==e.top&&e.name===g}catch(e){return!0}}const p="[Storage]["+location.host+"] ";let f=null;const b=`${p} Is not initialized yet.`;let y=!1;function S(t,s=!1){e.isInitialized?console.debug(`${p} Already initialized`):(y=s,console.debug(`${p}Initialize (running in editor: ${y})`,t),f=new d(t.crossDomainStorageUrl),m(window)?k.registerListeners():console.debug(`${p}Not running inside IFrame. Cross-domain stub creation skipped.`),e.isInitialized=!0)}function q(){f&&(f.dispose(),f=null),m(window)&&k.deregisterListeners(),y=!1,e.isInitialized=!1,console.debug(`${p}disposed`)}e.isInitialized=!1;const w=function(e){console.error(b),e&&e(b)},v=()=>null==f||f.isDisabled(),V=function(){const e=c.getValue("feedback");return null!=e?JSON.parse(e):{journeys:[]}};class k{static deregisterListeners(){window.removeEventListener("message",k.handleRequest,!1)}}k.handleRequest=e=>{e.origin;try{const t=JSON.parse(e.data);if("get-value"===t.operation){const s=c.getGlobalValue(t.key,t.storageType);e.source.postMessage(n.JSON.stringify({operation:"response-get-value",id:t.id,key:t.key,value:s}),e.origin)}else if("get-values"===t.operation){const s=c.getGlobalValues(t.keys,t.storageType);e.source.postMessage(n.JSON.stringify({operation:"response-get-values",id:t.id,keys:t.keys,values:s,toJSON(){return this}}),e.origin)}else"remove-values"===t.operation?c.removeGlobalValues(t.keys,t.storageType):"store-value"===t.operation?c.storeGlobalValue(t.key,t.value,t.expiration,t.storageType):"clean-storage"===t.operation&&c.clean()}catch(e){console.error(e)}},k.registerListeners=function(){window.addEventListener("message",k.handleRequest,!1),window.parent.postMessage(n.JSON.stringify({operation:"storage-ready"}),"*"),console.debug(`${p}Cross-Domain Storage Stub ready.`)};const I={init:S,dispose:q};return e.Storage=I,e.clean=function(){!v()&&f&&f.clean(),c.clean()},e.dispose=q,e.existsKey=function(e){return c.existsKey(e)},e.getFeedback=V,e.getGlobalOrLocalValue=function(e,t){const s=e;v()?t(e,c.getValue(e)):f.requestValue(e,(function(e,o,i){t(s,!e&&i?i:c.getValue(s))}))},e.getGlobalValue=function(e,t,s){v()?w(t):f.requestValue(e,t,s)},e.getGlobalValues=function(e,t,s){v()?w(t):f.requestValues(e,t,s)},e.getPersistenceValue=function(e){const t=JSON.parse(c.getValue("persistence")||"{}");return t&&t.hasOwnProperty(e)?t[e]:null},e.getValue=function(e){return c.getValue(e)},e.incrementPersistenceItemValue=function(e){const t=JSON.parse(c.getValue("persistence")||"{}");t[e]=(t[e]||0)+1,c.storeValue("persistence",n.JSON.stringify(t))},e.init=S,e.removeGlobalValues=function(e,t){v()?w():f.removeValues(e,t)},e.removeValue=function(e){c.removeValue(e)},e.removeValues=function(e){c.removeValues(e)},e.setPersistenceItem=function(e,t){const s=JSON.parse(c.getValue("persistence")||"{}");s[e]=t,c.storeValue("persistence",n.JSON.stringify(s))},e.storeFeedbackJourneyId=function(e){const t=V();t.journeys.indexOf(e)<0&&(n.array.push(t.journeys,e),c.storeValue("feedback",n.JSON.stringify(t)))},e.storeGlobalValue=function(e,t,s,o){v()?w():f.storeValue(e,t,s,o)},e.storeValue=function(e,t,s){c.storeValue(e,t,s)},Object.defineProperty(e,"__esModule",{value:!0}),e}({});